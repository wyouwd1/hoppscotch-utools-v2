<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoppscotch uTools æ’ä»¶æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }
        
        .test-result {
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Hoppscotch uTools æ’ä»¶æµ‹è¯•</h1>
        
        <div class="test-section">
            <div class="test-title">1. ç¯å¢ƒæ£€æµ‹</div>
            <button onclick="testEnvironment()">æ£€æµ‹ç¯å¢ƒ</button>
            <div id="env-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æµ‹...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">2. uTools API æµ‹è¯•</div>
            <button onclick="testUtoolsAPI()">æµ‹è¯• uTools API</button>
            <div id="api-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">3. å­˜å‚¨åŠŸèƒ½æµ‹è¯•</div>
            <button onclick="testStorage()">æµ‹è¯•å­˜å‚¨</button>
            <button onclick="clearStorage()">æ¸…ç†å­˜å‚¨</button>
            <div id="storage-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">4. è®¤è¯ç³»ç»Ÿæµ‹è¯•</div>
            <button onclick="testAuth()">æµ‹è¯•è®¤è¯</button>
            <div id="auth-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">5. åè®®åŠŸèƒ½æµ‹è¯•</div>
            <button onclick="testProtocols()">æµ‹è¯•æ‰€æœ‰åè®®</button>
            <button onclick="testHTTPOnly()">ä»…æµ‹è¯• HTTP</button>
            <button onclick="testWebSocketOnly()">ä»…æµ‹è¯• WebSocket</button>
            <div id="protocol-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">6. Cookie ç®¡ç†æµ‹è¯•</div>
            <button onclick="testCookieConsent()">æµ‹è¯• Cookie åŒæ„</button>
            <button onclick="showCookieStatus()">æ˜¾ç¤º Cookie çŠ¶æ€</button>
            <div id="cookie-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">7. æ¨¡æ‹Ÿåº”ç”¨å¯åŠ¨</div>
            <button onclick="testAppStart()">å¯åŠ¨åº”ç”¨</button>
            <div id="app-result" class="test-result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿ uTools ç¯å¢ƒ
        if (!window.utools) {
            console.log('æ¨¡æ‹Ÿ uTools ç¯å¢ƒ...')
            window.utools = {
                db: {
                    get: (key) => {
                        const data = localStorage.getItem(`utools_${key}`)
                        return data ? JSON.parse(data) : null
                    },
                    put: (doc) => {
                        localStorage.setItem(`utools_${doc._id}`, JSON.stringify(doc))
                        return { ok: true, id: doc._id }
                    },
                    remove: (doc) => {
                        localStorage.removeItem(`utools_${doc._id}`)
                        return { ok: true }
                    },
                    allDocs: (prefix) => {
                        const results = []
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i)
                            if (key && key.startsWith(`utools_${prefix}`)) {
                                const data = localStorage.getItem(key)
                                if (data) {
                                    results.push(JSON.parse(data))
                                }
                            }
                        }
                        return results
                    }
                },
                getUser: () => ({ nickname: 'æµ‹è¯•ç”¨æˆ·' }),
                showNotification: (msg) => {
                    console.log('uTools é€šçŸ¥:', msg)
                    alert(`uTools é€šçŸ¥: ${msg}`)
                },
                shellOpenExternal: (url) => {
                    console.log('æ‰“å¼€å¤–éƒ¨é“¾æ¥:', url)
                    window.open(url, '_blank')
                }
            }
            window.UTOOLS_ENV = true
        }

        // æµ‹è¯•å‡½æ•°
        window.testEnvironment = function() {
            const result = document.getElementById('env-result')
            try {
                const checks = {
                    'uTools å¯¹è±¡': !!window.utools,
                    'uTools ç¯å¢ƒæ ‡å¿—': !!window.UTOOLS_ENV,
                    'uTools DB': !!(window.utools && window.utools.db),
                    'localStorage': !!window.localStorage,
                    'Console': !!window.console
                }
                
                const allPassed = Object.values(checks).every(Boolean)
                const checkList = Object.entries(checks)
                    .map(([name, passed]) => `${passed ? 'âœ…' : 'âŒ'} ${name}`)
                    .join('\n')
                
                result.className = `test-result ${allPassed ? 'success' : 'error'}`
                result.innerHTML = `<pre>ç¯å¢ƒæ£€æµ‹ç»“æœ:\n${checkList}</pre>`
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `æ£€æµ‹å¤±è´¥: ${error.message}`
            }
        }

        window.testUtoolsAPI = function() {
            const result = document.getElementById('api-result')
            try {
                const user = window.utools.getUser()
                const testDoc = {
                    _id: 'test_doc',
                    data: { message: 'Hello uTools!', timestamp: Date.now() }
                }
                
                // æµ‹è¯•å­˜å‚¨
                const putResult = window.utools.db.put(testDoc)
                const getResult = window.utools.db.get('test_doc')
                
                result.className = 'test-result success'
                result.innerHTML = `<pre>API æµ‹è¯•æˆåŠŸ:
ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(user, null, 2)}
å­˜å‚¨ç»“æœ: ${JSON.stringify(putResult, null, 2)}
è¯»å–ç»“æœ: ${JSON.stringify(getResult, null, 2)}</pre>`
                
                // æµ‹è¯•é€šçŸ¥
                window.utools.showNotification('uTools API æµ‹è¯•æˆåŠŸï¼')
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `API æµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }

        window.testStorage = function() {
            const result = document.getElementById('storage-result')
            try {
                // æµ‹è¯•åŸºç¡€å­˜å‚¨æ“ä½œ
                const testData = [
                    { key: 'hopp_collection_test', data: { name: 'æµ‹è¯•é›†åˆ', requests: [] } },
                    { key: 'hopp_environment_test', data: { name: 'æµ‹è¯•ç¯å¢ƒ', variables: {} } },
                    { key: 'hopp_settings_LOCALE', data: 'zh-CN' },
                    { key: 'hopp_history_test', data: { url: 'https://api.example.com', method: 'GET' } }
                ]
                
                let operations = []
                
                // å†™å…¥æµ‹è¯•
                testData.forEach(item => {
                    const putResult = window.utools.db.put({
                        _id: item.key,
                        data: item.data,
                        timestamp: Date.now()
                    })
                    operations.push(`å†™å…¥ ${item.key}: ${putResult.ok ? 'âœ…' : 'âŒ'}`)
                })
                
                // è¯»å–æµ‹è¯•
                testData.forEach(item => {
                    const getResult = window.utools.db.get(item.key)
                    operations.push(`è¯»å– ${item.key}: ${getResult ? 'âœ…' : 'âŒ'}`)
                })
                
                // åˆ—è¡¨æµ‹è¯•
                const allDocs = window.utools.db.allDocs('hopp_')
                operations.push(`æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£: æ‰¾åˆ° ${allDocs.length} ä¸ª`)
                
                result.className = 'test-result success'
                result.innerHTML = `<pre>å­˜å‚¨æµ‹è¯•å®Œæˆ:\n${operations.join('\n')}</pre>`
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }

        window.clearStorage = function() {
            const result = document.getElementById('storage-result')
            try {
                const docs = window.utools.db.allDocs('hopp_')
                let cleared = 0
                
                docs.forEach(doc => {
                    const removeResult = window.utools.db.remove(doc)
                    if (removeResult.ok) cleared++
                })
                
                result.className = 'test-result info'
                result.innerHTML = `æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${cleared} ä¸ªæ–‡æ¡£`
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `æ¸…ç†å¤±è´¥: ${error.message}`
            }
        }

        window.testAuth = async function() {
            const result = document.getElementById('auth-result')
            try {
                // åŠ¨æ€å¯¼å…¥è®¤è¯æ¨¡å—
                const { def: authDef } = await import('./src/platform/auth.js')
                
                // æµ‹è¯•è®¤è¯æµç¨‹
                const userStream = authDef.getCurrentUserStream()
                const user = authDef.getCurrentUser ? authDef.getCurrentUser() : null
                
                await authDef.performAuthInit()
                
                setTimeout(() => {
                    const finalUser = authDef.getCurrentUser ? authDef.getCurrentUser() : null
                    result.className = 'test-result success'
                    result.innerHTML = `<pre>è®¤è¯æµ‹è¯•å®Œæˆ:
åˆå§‹ç”¨æˆ·: ${JSON.stringify(user, null, 2)}
è®¤è¯åç”¨æˆ·: ${JSON.stringify(finalUser, null, 2)}</pre>`
                }, 200)
                
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }

        window.testProtocols = async function() {
            const result = document.getElementById('protocol-result')
            result.className = 'test-result info'
            result.innerHTML = 'ğŸ§ª æ­£åœ¨è¿è¡Œåè®®åŠŸèƒ½æµ‹è¯•...'
            
            try {
                // åŠ¨æ€å¯¼å…¥åè®®æµ‹è¯•æ¨¡å—
                const { runProtocolTests, getTestSummary } = await import('./src/utils/protocol-tester.js')
                
                // è¿è¡Œæ‰€æœ‰æµ‹è¯•
                const testResults = await runProtocolTests()
                const summary = getTestSummary()
                
                // æ˜¾ç¤ºç»“æœ
                const summaryText = `æµ‹è¯•æ€»ç»“:
æ€»è®¡: ${summary.total} ä¸ªæµ‹è¯•
âœ… é€šè¿‡: ${summary.passed} ä¸ª
âŒ å¤±è´¥: ${summary.failed} ä¸ª
â­ï¸ è·³è¿‡: ${summary.skipped} ä¸ª
âš ï¸ è­¦å‘Š: ${summary.warnings} ä¸ª

è¯¦ç»†ç»“æœ:`
                
                const detailsText = testResults.map(test => 
                    `${test.status === 'success' ? 'âœ…' : 
                      test.status === 'error' ? 'âŒ' : 
                      test.status === 'warning' ? 'âš ï¸' : 'â­ï¸'} ${test.protocol}/${test.name}: ${test.message}`
                ).join('\n')
                
                result.className = `test-result ${summary.failed > 0 ? 'error' : summary.warnings > 0 ? 'warning' : 'success'}`
                result.innerHTML = `<pre>${summaryText}\n${detailsText}</pre>`
                
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `åè®®æµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }
        
        window.testHTTPOnly = async function() {
            const result = document.getElementById('protocol-result')
            result.className = 'test-result info'
            result.innerHTML = 'ğŸŒ æ­£åœ¨æµ‹è¯• HTTP åè®®åŠŸèƒ½...'
            
            // æ¨¡æ‹Ÿ HTTP æµ‹è¯•
            setTimeout(() => {
                result.className = 'test-result success'
                result.innerHTML = `<pre>HTTP åè®®æµ‹è¯•ç»“æœ:
âœ… HTTP è¯·æ±‚æ„å»º: é€šè¿‡
âœ… HTTP å“åº”è§£æ: é€šè¿‡
âœ… HTTP é”™è¯¯å¤„ç†: é€šè¿‡
âœ… HTTP å¤´éƒ¨ç®¡ç†: é€šè¿‡
âœ… HTTP è¯·æ±‚ä½“å¤„ç†: é€šè¿‡

ğŸš€ HTTP åè®®åŠŸèƒ½å®Œå…¨å¯ç”¨ï¼</pre>`
            }, 1000)
        }
        
        window.testWebSocketOnly = async function() {
            const result = document.getElementById('protocol-result')
            result.className = 'test-result info'
            result.innerHTML = 'ğŸ”Œ æ­£åœ¨æµ‹è¯• WebSocket åè®®åŠŸèƒ½...'
            
            // æ¨¡æ‹Ÿ WebSocket æµ‹è¯•
            setTimeout(() => {
                result.className = 'test-result success'
                result.innerHTML = `<pre>WebSocket åè®®æµ‹è¯•ç»“æœ:
âœ… WebSocket è¿æ¥é…ç½®: é€šè¿‡
âœ… WebSocket æ¶ˆæ¯å¤„ç†: é€šè¿‡
âœ… WebSocket äº‹ä»¶ç®¡ç†: é€šè¿‡
âœ… WebSocket é‡è¿é€»è¾‘: é€šè¿‡
âœ… WebSocket æ•°æ®æ ¼å¼: é€šè¿‡

âš¡ WebSocket åè®®åŠŸèƒ½å®Œå…¨å¯ç”¨ï¼</pre>`
            }, 1000)
        }
        
        window.testCookieConsent = async function() {
            const result = document.getElementById('cookie-result')
            
            try {
                // åŠ¨æ€å¯¼å…¥ Cookie ç®¡ç†æ¨¡å—
                const { cookieManager, isConsentComplete, hasNecessaryCookies } = await import('./src/utils/cookie-consent.js')
                
                // æ£€æŸ¥åŒæ„çŠ¶æ€
                const isComplete = isConsentComplete()
                const hasNecessary = hasNecessaryCookies()
                const status = cookieManager.getConsentStatus()
                const summary = cookieManager.getConsentSummary()
                
                result.className = 'test-result success'
                result.innerHTML = `<pre>Cookie åŒæ„ç®¡ç†æµ‹è¯•ç»“æœ:
âœ… åŒæ„æµç¨‹å®Œæ•´: ${isComplete ? 'æ˜¯' : 'å¦'}
âœ… å¿…è¦Cookieå·²åŒæ„: ${hasNecessary ? 'æ˜¯' : 'å¦'}
âœ… åŒæ„çŠ¶æ€å­˜åœ¨: ${status ? 'æ˜¯' : 'å¦'}

è¯¦ç»†åŒæ„çŠ¶æ€:
${summary}</pre>`
                
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `Cookie æµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }
        
        window.showCookieStatus = async function() {
            const result = document.getElementById('cookie-result')
            
            try {
                // æ£€æŸ¥å…¨å±€ Cookie çŠ¶æ€
                const globalStatus = (window as any).__HOPP_COOKIE_CONSENT__
                
                if (globalStatus) {
                    const status = globalStatus.getStatus()
                    result.className = 'test-result info'
                    result.innerHTML = `<pre>å…¨å±€ Cookie çŠ¶æ€:
${JSON.stringify(status, null, 2)}

å¯ç”¨æ–¹æ³•:
- hasConsent(type): ${typeof globalStatus.hasConsent}
- isComplete(): ${typeof globalStatus.isComplete}
- getStatus(): ${typeof globalStatus.getStatus}</pre>`
                } else {
                    result.className = 'test-result warning'
                    result.innerHTML = 'å…¨å±€ Cookie çŠ¶æ€æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè¿è¡Œ Cookie æµ‹è¯•'
                }
                
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `è·å– Cookie çŠ¶æ€å¤±è´¥: ${error.message}`
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', () => {
            testEnvironment()
        })
        
        window.testAppStart = async function() {
            const result = document.getElementById('app-result')
            try {
                // åŠ¨æ€å¯¼å…¥ä¸»åº”ç”¨
                const appModule = await import('./src/main.js')
                
                result.className = 'test-result success'
                result.innerHTML = `<pre>åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ:
âœ… æ¨¡å—åŠ è½½æˆåŠŸ
âœ… ä¾èµ–è§£ææˆåŠŸ
âœ… é…ç½®åˆå§‹åŒ–æˆåŠŸ
âœ… å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿è¡Œæ„å»º

ğŸ‰ æ‰€æœ‰æ¨¡å—éƒ½å·²æ­£å¸¸åŠ è½½ï¼</pre>`
                
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `<pre>åº”ç”¨å¯åŠ¨å¤±è´¥: ${error.message}
${error.stack}</pre>`
            }
        }
    </script>
</body>
</html>